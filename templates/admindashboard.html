{% extends "base.html" %}
{% block content %}
<style>
  /* faqat Statistika title uchun */
  h3.nk-block-title.page-title {
      margin-top: 25px !important;
      position: relative !important;
      z-index: 9999 !important;
      display: block !important;
      overflow: visible !important;
      color: black !important; /* matn ko‘rinsin */
      font-size: 24px !important; /* kerak bo‘lsa */
  }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
<div class="nk-content container-fluid">
  <div class="nk-content-inner">
    <div class="nk-content-body">
      <!-- Sarlavha va foydalanuvchi -->
      <div class="nk-block-head nk-block-head-sm mb-3">
        <div class="nk-block-between align-items-center">
          <div class="nk-block-head-content">
            <h3 class="nk-block-title page-title">Statistika</h3>
            <div class="nk-block-des text-soft">
              <p>Assalomu alaykum, 
                {% if request.user.get_full_name %}
                  {{ request.user.get_full_name }}
                {% else %}
                  {{ request.user.username }}
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Filter form -->
      <div class="card mb-4">
        <div class="card-body">
          <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Vaqt oralig'i:</label>
              <select name="period" onchange="this.form.submit()" class="form-select">
                <option value="30" {% if period == '30' %}selected{% endif %}>Oxirgi 30 kun</option>
                <option value="7" {% if period == '7' %}selected{% endif %}>Oxirgi 1 hafta</option>
                <option value="1" {% if period == '1' %}selected{% endif %}>Bugungi kun</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Boshlangan sana:</label>
              <input type="text" id="start_date" name="start_date"
                    value="{{ request.GET.start_date|default_if_none:'' }}"
                    class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Tugagan sana:</label>
              <input type="text" id="end_date" name="end_date"
                    value="{{ request.GET.end_date|default_if_none:'' }}"
                    class="form-control">
            </div>
            <div class="col-md-3">
              <button type="submit" class="btn btn-primary w-100">Filter</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Statistikalar -->
      <div class="nk-block">
        <div class="row g-gs">

          <div class="col-xxl-3 col-sm-6">
            <div class="card"><div class="card-inner"><h6 class="title">Kelgan dorilar</h6><div class="amount">{{ incoming }}</div></div></div>
          </div>
          <div class="col-xxl-3 col-sm-6">
            <div class="card"><div class="card-inner"><h6 class="title">Ishlatilgan dorilar</h6><div class="amount">{{ used }}</div></div></div>
          </div>
          <div class="col-xxl-3 col-sm-6">
            <div class="card"><div class="card-inner"><h6 class="title">Qolgan dorilar</h6><div class="amount">{{ remaining }}</div></div></div>
          </div>
          <div class="col-xxl-3 col-sm-6">
            <div class="card"><div class="card-inner"><h6 class="title">Yangi bemorlar</h6><div class="amount">{{ new_patients }}</div></div></div>
          </div>
          <div class="col-xxl-3 col-sm-6">
            <div class="card"><div class="card-inner"><h6 class="title">O‘tkazilgan dorilar</h6><div class="amount">{{ transferred }}</div></div></div>
          </div>

        </div>
      </div>

      <!-- Dorilar tarixi -->
      <div class="card mt-5">
        <div class="card-header"><h5>Dorilar tarixi</h5></div>
        <div class="card-body table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Sana</th>
                <th>Dori nomi</th>
                <th>Miqdori</th>
                <th>Amal</th>
                <th>Kim tomonidan</th>
                <th>Kimga / Qayerga</th>
              </tr>
            </thead>
            <tbody>
              {% for item in history %}
              <tr>
                <td>{{ item.created_at|date:"Y-m-d H:i" }}</td>
                <td>{{ item.medicine.name }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.get_action_display }}</td>
                <td>{{ item.user.get_full_name|default:item.user.username }}</td>
                <td>
                  {% if item.to_user %}
                    {{ item.to_user.get_full_name|default:item.to_user.username }}
                  {% elif item.to_place %}
                    {{ item.to_place.name }}
                  {% else %}
                    {{ item.to_patient.name }} {{ item.to_patient.surname }}
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="6" class="text-center">Ma'lumot yo‘q</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>
<script>
  flatpickr("#start_date", {
    dateFormat: "Y-m-d",
    altInput: true,
    altFormat: "d-m-Y",
    locale: "ru",
    defaultDate: "{{ request.GET.start_date|default_if_none:'' }}"
  });

  flatpickr("#end_date", {
    dateFormat: "Y-m-d",
    altInput: true,
    altFormat: "d-m-Y",
    locale: "ru",
    defaultDate: "{{ request.GET.end_date|default_if_none:'' }}"
  });
</script>
{% endblock %}
